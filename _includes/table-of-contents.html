<!-- Table of Contents -->
<aside class="table-of-contents" id="tableOfContents">
    <nav class="toc-nav" role="navigation">
        <ul class="toc-list" id="tocList">
            <!-- Table of contents will be populated by JavaScript -->
        </ul>
    </nav>
</aside>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üìö Table of contents loaded');

        const tocList = document.getElementById('tocList');
        const articleBody = document.querySelector('.article-body');
        const layoutContent = document.querySelector('.layout-content');

        if (!tocList || !articleBody || !layoutContent) {
            console.log('‚ùå Table of contents elements not found');
            return;
        }

        // Check if there's enough room in the right margin
        function checkRightMargin() {
            const container = layoutContent.querySelector('.container');
            if (!container) return true; // Default to showing if we can't find container

            const containerRect = container.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const rightMargin = viewportWidth - containerRect.right;

            console.log('üìè Container right edge:', containerRect.right);
            console.log('üìè Viewport width:', viewportWidth);
            console.log('üìè Right margin available:', rightMargin);

            // Need at least 180px for the table of contents (reduced further)
            return rightMargin >= 180;
        }

        // Find all headers in the article body
        const headers = articleBody.querySelectorAll('h1, h2, h3, h4, h5, h6');

        if (headers.length === 0) {
            console.log('üìù No headers found in article');
            hideTableOfContents();
            return;
        }

        console.log('üìö Found', headers.length, 'headers in article');
        console.log('üìè Right margin check:', checkRightMargin());

        function hideTableOfContents() {
            const tocContainer = document.getElementById('tableOfContents');
            if (tocContainer) {
                tocContainer.classList.remove('visible');
            }
        }

        // Create table of contents items
        headers.forEach((header, index) => {
            // Create ID for the header if it doesn't have one
            if (!header.id) {
                header.id = 'header-' + index;
            }

            const listItem = document.createElement('li');
            listItem.className = 'toc-item';

            // Determine indentation based on header level
            const headerLevel = parseInt(header.tagName.charAt(1));
            const indentClass = 'toc-indent-' + Math.min(headerLevel - 1, 3); // Max 3 levels of indentation

            const link = document.createElement('a');
            link.href = '#' + header.id;
            link.className = 'toc-link ' + indentClass;
            link.textContent = header.textContent.trim();

            // Add click handler for smooth scrolling
            link.addEventListener('click', function (e) {
                e.preventDefault();
                header.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            });

            listItem.appendChild(link);
            tocList.appendChild(listItem);
        });

        console.log('üìù Created', tocList.children.length, 'TOC items');
        console.log('üìù TOC HTML:', tocList.innerHTML.substring(0, 200) + '...');

        // Highlight current section on scroll
        const observerOptions = {
            root: null,
            rootMargin: '-20% 0px -70% 0px',
            threshold: 0
        };

        const headerObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const headerId = entry.target.id;
                const tocLink = document.querySelector(`.toc-link[href="#${headerId}"]`);

                if (tocLink) {
                    if (entry.isIntersecting) {
                        // Remove active class from all links
                        document.querySelectorAll('.toc-link').forEach(link => {
                            link.classList.remove('toc-active');
                        });
                        // Add active class to current link
                        tocLink.classList.add('toc-active');
                    }
                }
            });
        }, observerOptions);

        // Observe all headers
        headers.forEach(header => {
            headerObserver.observe(header);
        });

        // Show/hide logic based on scroll position
        function showTableOfContents() {
            const tocContainer = document.getElementById('tableOfContents');
            if (!tocContainer) return;

            // Check if we have enough room
            if (!checkRightMargin()) {
                tocContainer.classList.remove('visible');
                return;
            }

            // Get the layout content position
            const layoutContentRect = layoutContent.getBoundingClientRect();
            const heroHeight = 200; // Approximate hero section height

            // Only show when we're past the hero section (in main content area)
            if (layoutContentRect.top <= heroHeight) {
                tocContainer.classList.add('visible');
                console.log('üì± TOC: Showing (in main content area)');
            } else {
                // Remove transition temporarily for instant hide
                tocContainer.style.transition = 'none';
                tocContainer.classList.remove('visible');
                // Restore transition after a brief moment
                setTimeout(() => {
                    tocContainer.style.transition = '';
                }, 10);
                console.log('üì± TOC: Hiding (in hero section)');
            }
        }

        // Initial show
        showTableOfContents();

        // Update on scroll and resize
        window.addEventListener('scroll', showTableOfContents);

        console.log('‚úÖ Table of contents initialized with', headers.length, 'headers');
        console.log('üîç TOC container display:', document.getElementById('tableOfContents')?.style.display);
        console.log('üîç TOC container visibility:', document.getElementById('tableOfContents')?.style.visibility);

        // Listen for window resize to check margin availability
        window.addEventListener('resize', function () {
            showTableOfContents();
        });
    });
</script>

<style>
    .table-of-contents {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1000;
        width: 240px;
        background: transparent;
        border-radius: 8px;
        border: none;
        overflow: visible;
        font-family: inherit;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
        padding: 12px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;

        /* Hide on small devices */
        @media (max-width: 1400px) {
            display: none;
        }
    }

    .table-of-contents.visible {
        opacity: 1;
        visibility: visible;
    }

    .toc-nav {
        padding: 0;
    }

    .toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .toc-item {
        margin-bottom: 6px;

        &:last-child {
            margin-bottom: 0;
        }
    }

    .toc-link {
        display: block;
        color: #111827;
        /* gray-900 for white background */
        text-decoration: none;
        font-size: 16px;
        font-weight: 400;
        padding: 3px 0;
        position: relative;
        transition: color 0.2s ease;
        line-height: 1.3;

        &:hover {
            color: #374151;
            /* darker on hover */
            text-decoration: none;
        }

        &.toc-active {
            color: #374151;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            font-size: 11px;
            padding: 2px 0;
        }
    }

    /* Indentation for different header levels */
    .toc-indent-0 {
        padding-left: 0;
    }

    .toc-indent-1 {
        font-size: 16px;

        @media (max-width: 1200px) {
            font-size: 14px;
        }

        @media (max-width: 768px) {
            font-size: 12px;
        }
    }

    .toc-indent-2 {
        padding-left: 32px;
        font-size: 12px;
        color: #6b7280;
    }

    .toc-indent-3 {
        padding-left: 48px;
        font-size: 11px;
        color: #9ca3af;
    }
</style>