<!-- Mobile Menu Button -->
<button id="mobile-menu-btn" class="mobile-menu-btn" aria-label="Open navigation menu" aria-expanded="false">
    <i class="fa fa-bars" aria-hidden="true"></i>
</button>

<!-- Sidebar Controls Container - Brand and Toggle -->
<div class="sidebar-controls">
    <!-- Brand/Logo -->
    <div class="sidebar-brand">
        <a href="{{ '/' | relative_url }}" class="brand-link" aria-label="Prosody Labs home">
            <div class="brand-icon" aria-hidden="true">
                <i class="fa fa-flask"></i>
            </div>
            <span class="brand-text">Prosody Labs</span>
        </a>
    </div>

    <!-- Sidebar Toggle Button -->
    <div class="sidebar-toggle-container">
        <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle sidebar" aria-expanded="true">
            <i class="fa fa-bars" aria-hidden="true"></i>
        </button>
    </div>
</div>

<!-- Sidebar Navigation -->
<nav id="sidebarNav" class="sidebar-nav" role="navigation" aria-label="Main navigation">
    <div class="sidebar-content">
        <!-- Navigation Menu -->
        <ul class="sidebar-menu" role="menubar">
            <li class="menu-item" role="none">
                <a href="{{ '/projects.html' | relative_url }}"
                    class="menu-link {% if page.url contains 'projects' %}active{% endif %}" role="menuitem" {% if
                    page.url contains 'projects' %}aria-current="page" {% endif %}>
                    <div class="menu-icon" aria-hidden="true">
                        <i class="fa fa-code"></i>
                    </div>
                    <span class="menu-text">Projects</span>
                </a>
            </li>

            <li class="menu-item" role="none">
                <a href="{{ '/publications.html' | relative_url }}"
                    class="menu-link {% if page.url contains 'publications' %}active{% endif %}" role="menuitem" {% if
                    page.url contains 'publications' %}aria-current="page" {% endif %}>
                    <div class="menu-icon" aria-hidden="true">
                        <i class="fa fa-file-text-o"></i>
                    </div>
                    <span class="menu-text">Publications</span>
                </a>
            </li>

            <li class="menu-item" role="none">
                <a href="{{ '/blog.html' | relative_url }}"
                    class="menu-link {% if page.url contains 'blog' %}active{% endif %}" role="menuitem" {% if page.url
                    contains 'blog' %}aria-current="page" {% endif %}>
                    <div class="menu-icon" aria-hidden="true">
                        <i class="fa fa-pencil"></i>
                    </div>
                    <span class="menu-text">Blog</span>
                </a>
            </li>
        </ul>
    </div>
</nav>

<!-- Sidebar overlay for mobile -->
<div id="sidebarOverlay" class="sidebar-overlay" aria-hidden="true"></div>

<!-- Preload critical state to prevent flickering -->
<script>
    (function () {
        const savedState = localStorage.getItem('sidebarCollapsed');
        if (savedState === 'true') {
            document.documentElement.classList.add('sidebar-collapsed-immediate');
        }
    })();
</script>

<!-- Sidebar Navigation JavaScript -->
<script>
    (function () {
        'use strict';

        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSidebar);
        } else {
            initializeSidebar();
        }

        function initializeSidebar() {
            // Get elements
            const sidebar = document.getElementById('sidebarNav');
            const toggle = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const body = document.body;

            // Early return if elements don't exist
            if (!sidebar || !toggle || !overlay || !mobileMenuBtn) {
                console.warn('Sidebar elements not found');
                return;
            }

            // State management
            let isDesktop = window.innerWidth > 768;
            let isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

            // Initialize desktop state
            function initializeDesktopState() {
                if (isDesktop) {
                    body.classList.add('sidebar-open');
                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        body.classList.add('sidebar-collapsed');
                        updateToggleAria(false);
                    } else {
                        updateToggleAria(true);
                    }
                }
                // Remove immediate class after state is set
                document.documentElement.classList.remove('sidebar-collapsed-immediate');
            }

            // Update ARIA attributes
            function updateToggleAria(expanded) {
                toggle.setAttribute('aria-expanded', expanded.toString());
            }

            function updateMobileAria(open) {
                mobileMenuBtn.setAttribute('aria-expanded', open.toString());
                overlay.setAttribute('aria-hidden', (!open).toString());
            }

            // Toggle sidebar collapse (desktop)
            function toggleSidebar() {
                const wasCollapsed = sidebar.classList.contains('collapsed');

                sidebar.classList.toggle('collapsed');
                body.classList.toggle('sidebar-collapsed');

                isCollapsed = !wasCollapsed;
                localStorage.setItem('sidebarCollapsed', isCollapsed.toString());
                updateToggleAria(!isCollapsed);

                // Focus management
                if (isCollapsed) {
                    // Focus on toggle button when collapsed
                    toggle.focus();
                }
            }

            // Open mobile sidebar
            function openMobileSidebar() {
                sidebar.classList.add('mobile-open');
                overlay.classList.add('active');
                updateMobileAria(true);

                // Trap focus in sidebar
                const firstFocusable = sidebar.querySelector('a, button');
                if (firstFocusable) {
                    firstFocusable.focus();
                }
            }

            // Close mobile sidebar
            function closeMobileSidebar() {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
                updateMobileAria(false);

                // Return focus to mobile menu button
                mobileMenuBtn.focus();
            }

            // Handle window resize
            function handleResize() {
                const wasDesktop = isDesktop;
                isDesktop = window.innerWidth > 768;

                if (isDesktop && !wasDesktop) {
                    // Switching to desktop
                    closeMobileSidebar();
                    body.classList.add('sidebar-open');
                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        body.classList.add('sidebar-collapsed');
                    }
                } else if (!isDesktop && wasDesktop) {
                    // Switching to mobile
                    body.classList.remove('sidebar-open', 'sidebar-collapsed');
                    sidebar.classList.remove('collapsed');
                }
            }

            // Keyboard navigation
            function handleKeyDown(event) {
                if (event.key === 'Escape' && !isDesktop) {
                    if (sidebar.classList.contains('mobile-open')) {
                        closeMobileSidebar();
                    }
                }
            }

            // Event listeners
            toggle.addEventListener('click', toggleSidebar);
            mobileMenuBtn.addEventListener('click', openMobileSidebar);
            overlay.addEventListener('click', closeMobileSidebar);
            window.addEventListener('resize', debounce(handleResize, 100));
            document.addEventListener('keydown', handleKeyDown);

            // Initialize state
            initializeDesktopState();
        }

        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    })();
</script>